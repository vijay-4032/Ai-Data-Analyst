<!-- templates/dashboard.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Data Analyst Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">AI</div>
      </div>
      <nav class="icons">
        <button class="icon-btn active">üè†</button>
        <button class="icon-btn">üë•</button>
        <button class="icon-btn">üìä</button>
        <button class="icon-btn">üè∑</button>
        <button class="icon-btn">‚öôÔ∏è</button>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="title">Web App</div>
        <div class="actions">
          <form method="POST" enctype="multipart/form-data" action="{{ url_for('index') }}" id="upload-form">
            <input type="file" name="file" id="file-input" accept=".csv" style="display:none" onchange="document.getElementById('upload-form').submit();" />
            <button type="button" class="btn upload" onclick="document.getElementById('file-input').click()">Upload CSV</button>
          </form>
          <button class="btn primary">Global</button>
          <div class="avatar">VT</div>
        </div>
      </header>

      <section class="content">
        <!-- KPIs Row -->
        <div class="kpi-row">
          {% if kpis %}
            {% for k, v in kpis.items() %}
              <div class="card kpi">
                <div class="kpi-label">{{ k }}</div>
                <div class="kpi-value">{{ v }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="card kpi">Upload CSV to generate KPIs</div>
          {% endif %}
        </div>

        <!-- Grid with charts and lists (replicates the reference layout) -->
        <div class="grid">
          <div class="card big-chart">
            <div class="card-title">Bar / Column</div>
            {% if charts and charts|length > 0 %}
              <div class="plotly-embed">{{ charts[0]|safe }}</div>
            {% else %}
              <div class="placeholder">Upload a CSV to see charts</div>
            {% endif %}
          </div>

          <div class="card donut">
            <div class="card-title">Analytics</div>
            {% if charts and charts|length > 1 %}
              <div class="plotly-embed">{{ charts[1]|safe }}</div>
            {% else %}
              <div class="placeholder">Distribution</div>
            {% endif %}
          </div>

          <div class="card line-chart">
            <div class="card-title">Trend</div>
            {% if charts and charts|length > 2 %}
              <div class="plotly-embed">{{ charts[2]|safe }}</div>
            {% else %}
              <div class="placeholder">Trends</div>
            {% endif %}
          </div>

          <div class="card right-small">
            <div class="card-title">Details</div>
            <div class="body">
              <h4>Suggested Questions</h4>
              <ul class="suggestions">
                {% for q in questions %}
                  <li><button onclick="fillQuery('{{ q }}')">{{ q }}</button></li>
                {% endfor %}
              </ul>

              <h4>Preview</h4>
              <div class="preview">
                {{ preview|safe if preview else "<em>No preview</em>" }}
              </div>
            </div>
          </div>
        </div>

        <!-- Query box -->
        <div class="query-row card">
          <form id="analyze-form" onsubmit="return submitQuery(event);">
            <input type="hidden" name="uploaded" value="{{ filename if filename else '' }}" id="uploaded-name" />
            <input type="text" id="query-input" name="query" placeholder="Ask a question (e.g. Show total sales by region)" />
            <button class="btn primary" type="submit">Analyze</button>
          </form>

          <div id="analysis-result" class="analysis-result"></div>
        </div>

      </section>
    </main>
  </div>

  <script>
    function fillQuery(q) {
      document.getElementById('query-input').value = q;
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function submitQuery(ev) {
      ev.preventDefault();
      const uploaded = document.getElementById('uploaded-name').value;
      const query = document.getElementById('query-input').value;
      if (!uploaded) {
        alert('Please upload a CSV first.');
        return false;
      }
      if (!query) {
        alert('Please type a query.');
        return false;
      }

      const form = new FormData();
      form.append('uploaded', uploaded);
      form.append('query', query);

      const resEl = document.getElementById('analysis-result');
      resEl.innerHTML = "<p>Analyzing... üîç</p>";

      try {
        const resp = await fetch('/analyze', { method: 'POST', body: form });
        const data = await resp.json();
        if (data.error) {
          resEl.innerHTML = `<div class="error">${data.error}</div>`;
          return;
        }

        // render charts
        let html = `<h3>Explanation</h3><p>${data.explanation}</p>`;
        if (data.kpis && Object.keys(data.kpis).length) {
          html += '<div class="kpi-inline">';
          for (const [k, v] of Object.entries(data.kpis)) {
            html += `<div class="mini-kpi"><div class="label">${k}</div><div class="value">${v}</div></div>`;
          }
          html += '</div>';
        }

        if (data.result_preview) {
          html += `<h4>Result</h4>${data.result_preview}`;
        }

        if (data.charts && data.charts.length) {
          for (const chartHtml of data.charts) {
            html += `<div class="chart-embed">${chartHtml}</div>`;
          }
        }

        resEl.innerHTML = html;
      } catch (err) {
        resEl.innerHTML = `<div class="error">Error: ${err}</div>`;
      }
      return false;
    }
  </script>
</body>
</html>
